<!DOCTYPE html>
<html>

<head>
    <title>
        結果｜
    </title>
</head>

<body>
    <?php

    try {
        $pdo = new PDO( 'mysql:host=localhost;dbname=ranking;','kmmk','uwfyzcyr',
        [PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC] );
 
        } catch(PDOException $e){
            echo 'エラーが発生しました' . $e->getMessage();
        }

         $Data = $pdo->prepare('SELECT * FROM plan WHERE thread_id=?');
         $Data->execute(array($_REQUEST['thread_id']));
         $hyouji = $Data->fetch();

         echo $hyouji['theme'];
         echo 'ランキング';
         echo '<br>';
         echo $hyouji['comment'];
         $thread_id = $hyouji['thread_id'];

         echo '<br>';

    try {
        $stmt = $pdo->prepare('SELECT * FROM vote WHERE thread_id=? ORDER BY count DESC LIMIT 3');
        $stmt->execute(array($hyouji['thread_id']));
    
        foreach ($stmt as $row) {
            echo '◎';
            echo $row['name'].'<br>';
        }
    
    } catch (PDOException $e) {
        echo $e->getMessage();
    
    } finally {
        $pdo = null;
    }
    
    ?>
   
    <a href="http://localhost/tohyo.html?thread_id=<?php echo $thread_id; ?>">投票はこちら</a><br>

    <br>
    <iframe src="http://localhost/keijiban2.html?thread_id=<?php echo $thread_id; ?>" name="hyouzi" width="700" height="450">
    </iframe>
    <br />

    <br>
    <form method="POST" action="">
        名前：<input type="text" name="name" value="名無し" cols="97" />
        <textarea name="contents" rows="5" cols="97"></textarea><br />
        <input type="submit" value="投稿する" />
    </form>

<?php

    if(!empty($_POST['contents'])){
    try{
        $db = new PDO('mysql:dbname=ranking;host=localhost;charset=utf8','kmmk','uwfyzcyr');

        $name = $_POST['name'];
        $contents = $_POST['contents'];

        $sql2 = $db->prepare('INSERT INTO BBS(contents, date, thread_id, name) VALUES(:contents, NOW(), :thread_id, :name)');
        $sql2->execute(array(':contents' => $contents, ':thread_id' => $thread_id, ':name'=>$name));
        
    } catch(PDOException $e){
        echo 'DB接続エラー' . $e->getMessage();
    }
    }
?>

    <a href="TOP.html">戻る</a>

</body>

</html>