<!DOCTYPE html>
<html>

<head>
    <title>
        結果｜
    </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="bootstrap-5.2.2-dist/css/bootstrap.min.css">
</head>

<body style="padding-top: 5rem">
    <div class="container">
        <nav class="navbar navbar-expand navbar-light bg-light fixed-top">
          <a class="navbar-brand" href="TOP.html">　三大○○</a>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
              <li class="nav-item">
                <a class="nav-link" href="GAIYO.html">はじめに</a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  カテゴリ
                </a>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="CATEGORY1.html">生活</a></li>
                  <li><a class="dropdown-item" href="CATEGORY1.html">文化</a></li>
                  <li><a class="dropdown-item" href="CATEGORY1.html">科学</a></li>
                  <li><a class="dropdown-item" href="CATEGORY3.html">芸術</a></li>
                </ul>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="KIKAKU.html">新規スレッド作成</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="https://twitter.com/____kmmk">twitter</a>
              </li>
            </ul>
          </div>
        </nav>
        
        <div class="row">
            <h2 class="text-center">
    <?php
     try {
        $pdo = new PDO( 'mysql:host=localhost;dbname=ranking;','kmmk','uwfyzcyr',
        [PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC] );
 
        } catch(PDOException $e){
            echo 'エラーが発生しました' . $e->getMessage();
        }

         $Data = $pdo->prepare('SELECT * FROM plan WHERE thread_id=?');
         $Data->execute(array($_REQUEST['thread_id']));
         $hyouji = $Data->fetch();

         echo '三大';
         echo $hyouji['theme'];
         echo '<br>';
         echo $hyouji['comment'];

         $thread_id = $hyouji['thread_id'];
    ?>
            </h2>
        </div>

        <br>
        <div class="row">
            <div class="col-md-4">
  <h1 class="display-4">
   <?php
    try {
        $stmt = $pdo->prepare('SELECT * FROM vote WHERE thread_id=? ORDER BY count DESC LIMIT 3');
        $stmt->execute(array($hyouji['thread_id']));
    
        foreach ($stmt as $row) {
            echo '◎';
            echo $row['name'].'<br>';
        }
    
    } catch (PDOException $e) {
        echo $e->getMessage();
    
    } finally {
        $pdo = null;
    }
    
    ?>
  </h1>
    <br>
    <a href="http://localhost/tohyo.html?thread_id=<?php echo $thread_id; ?>">投票はこちら</a><br>
    <br>
        </div>

           <div class="col-md-8">
            <div class="row">
            <div class="col-6">
              <a href="keijiban.html?thread_id=<?php echo $thread_id; ?>">最新のコメントを表示</a>
            </div>
              <div class="col-6">
             <div class="dropdown">
                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                  掲示板に投稿する
                </button>
                <form class="dropdown-menu p-3" method="POST" action="">
                  <div class="mb-3">
                    <input type="text" name="name" class="form-control" value="名無し">
                  </div>
                  <div class="mb-3">
                    <textarea name="contents" class="form-control" row="3" placeholder="コメントを入力"></textarea>
                  </div>
                  <div class="mb-1">
                    <div class="form-check">
                        <button type="submit" class="btn btn-primary">送信</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
            </div>
              

           <br>

            <?php

            try {
                $pdo = new PDO(
                    'mysql:host=localhost;dbname=ranking;','kmmk','uwfyzcyr',
                    [PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC]
                );
            
                $stmt = $pdo->prepare('SELECT * FROM bbs WHERE thread_id=? ORDER BY date DESC');
                $stmt->execute(array($_REQUEST['thread_id']));
                $row_count = $stmt->rowCount();
        
                foreach ($stmt as $hyouji) {
                    echo $row_count, ' ';
                    $row_count -= 1;
                    echo $hyouji['name'];
                    echo '<br>';
                    echo nl2br($hyouji['contents']);
                    echo '<br>';
                    echo '<p style="text-align:right">';
                    echo $hyouji['date'];
                    echo '</p>';
                    echo '<hr>';
                }
            
            } catch (PDOException $e) {
                echo $e->getMessage();
            
            } finally {
                $pdo = null;
            }
        
        ?>


           </div>
        </div>

<?php

    if(!empty($_POST['contents'])){
    try{
        $db = new PDO('mysql:dbname=ranking;host=localhost;charset=utf8','kmmk','uwfyzcyr');

        $name = $_POST['name'];
        $contents = $_POST['contents'];

        $sql2 = $db->prepare('INSERT INTO BBS(contents, date, thread_id, name) VALUES(:contents, NOW(), :thread_id, :name)');
        $sql2->execute(array(':contents' => $contents, ':thread_id' => $thread_id, ':name'=>$name));

        
    } catch(PDOException $e){
        echo 'DB接続エラー' . $e->getMessage();
    }
    }
?>

    </div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" 
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" 
        crossorigin="anonymous"></script>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
        crossorigin="anonymous"></script>


</body>

</html>