<!DOCTYPE html>
<html>
    <head>
        <title>投票｜三大○○</title>
    </head>

    <body>
        <br />

        どれかひとつに投票してください<br />
        <form method="POST"><br />
            <?php
                $result = [];
                $select = filter_input(INPUT_POST, "select");
                $dsn = "mysql:host=keijiban-mysql;dbname=keijiban";
                $user = "root";
                $password = "password";
                if (isset($_POST["tohyo"]) && $select != "") {

                    try {
                        $pdo = new PDO($dsn, $user, $password);
                        $sql = "SELECT count FROM tohyo WHERE id=${select}";
                        $stmt = $pdo->query($sql);
                        $result = $stmt->fetchAll(PDO::FETCH_ASSOC);

                        $increment = $result[0]["count"] + 1;
                        $sql = "UPDATE tohyo SET count=${increment} WHERE id=${select}";
                        $stmt = $pdo->query($sql);
                    } catch (PDOException $e) {
                        print('Error:'.$e->getMessage());
                        die();
                    }
                }
            ?>
            <?php
                $result = [];

                try {
                    $pdo = new PDO($dsn, $user, $password);
                    $sql = "SELECT * FROM tohyo";
                    $stmt = $pdo->query($sql);
                    $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
                } catch (PDOException $e) {
                    print('Error:'.$e->getMessage());
                    die();
                }
                foreach($result as $value) {
                    $input = "<input type=\"radio\" name=\"select\" value=\"${value["id"]}\"/>${value["choice"]}: ${value["count"]}<br />";
                    print_r($input);
                }
            ?>
            <input type="submit" name="tohyo" value="投票" /><br />
        </form>

        <br />

        <form method="POST">
            <br />
            その他：<input type="text" name="entry" size="40" /><br />
            <input type="submit" value="エントリー" />
        </form>

        <br />

        <a href="index.html">戻る</a>

        <form method="POST">
            <input type="submit" name="test" value="DBテスト" />
        </form>
    </body>

    <?php
    $log_file = '../logs/log.txt';

    //1 ファイルを指定して開く
    $fp = fopen($log_file, 'r+b');
    $select = filter_input(INPUT_POST, 'select');

    //2 戻り値を検証してロックする
    if ($fp) {
        if (flock($fp, LOCK_EX)) {

            //3 fgetで各行を読み出す・4 前後の空白をトリミングする→格納していく
            while(!feof($fp)) { 
                $results[] = trim(fgets($fp));
            }

            //5 選択された項目を加算する
            if($select == 1) $results[1]++;
            if($select == 2) $results[2]++;
            if($select == 3) $results[3]++;
            if($select == 4) $results[4]++;
            if($select == 5) $results[5]++;
            if($select == 6) $results[6]++;
        
            //6 ファイルポイントを先頭に戻す
            rewind($fp);

            //7 書き込みを保存する
            foreach($results as $value) {
                fwrite($fp, $value . "\n");
              }
        }else{
            print('ファイルロックに失敗しました');
        }
        flock($fp, LOCK_UN);
    }

    //8 ファイルを閉じる
    fclose($fp);
?>
</html>
