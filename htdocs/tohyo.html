<!DOCTYPE html>
<html>

<head>
    <title>
        投票｜三大○○
    </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="bootstrap-5.2.2-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="./color.css">
</head>

<body style="padding-top: 5rem">
   <div class="container">
        <nav class="navbar navbar-expand navbar-dark bg-dark fixed-top">
          <a class="navbar-brand" href="TOP.html">　三大○○</a>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
              <li class="nav-item">
                <a class="nav-link" href="GAIYO.html">はじめに</a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  カテゴリ
                </a>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="CATEGORY1.html">生活</a></li>
                  <li><a class="dropdown-item" href="CATEGORY2.html">文化</a></li>
                  <li><a class="dropdown-item" href="CATEGORY3.html">科学</a></li>
                  <li><a class="dropdown-item" href="CATEGORY4.html">芸術</a></li>
                </ul>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="KIKAKU.html">新規スレッド作成</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="https://twitter.com/____kmmk">twitter</a>
              </li>
            </ul>
          </div>
        </nav>
    <br/>
<!-- $thread_idを獲得 -->
    <?php    
            try{
                $db = new PDO('mysql:dbname=ranking;host=localhost;charset=utf8','kmmk','uwfyzcyr');
            
                  $Data = $db->prepare('SELECT * FROM plan WHERE thread_id=?');
                  $Data->execute(array($_REQUEST['thread_id']));
                  $hyouji = $Data->fetch();
                  $thread_id = $hyouji['thread_id'];

                } catch(PDOException $e){
                 echo 'エラーが発生しました' . $e->getMessage();
             }

    ?>

    <div class="row">
<!-- PHP処理 -->
      <div class="col-md-6 text-dark">
        3つ投票できます<br>            

        <?php
//投票
            if(!empty($_POST['vote'])){
                try{
                    $check_user = $db->prepare('SELECT * FROM user WHERE IP = ? AND thread_id = ?');
                    $check_user->execute(array($_SERVER['REMOTE_ADDR'], $thread_id));
                    $kakunin_user = $check_user->fetch();
                    if(isset($kakunin_user['IP'], $kakunin_user['thread_id'])){
                      echo '<script>window.confirm("投票は1人1回までです。")</script>';
                    }else{
                      foreach($_POST['vote'] as $value){
                        $sql2 = $db->prepare('UPDATE vote SET count = count+1 WHERE id = ?');
                        $sql2->execute(array($value));
                      }
                      $sql3 = $db->prepare('INSERT INTO user SET IP = ?, thread_id = ?');
                      $sql3->execute(array($_SERVER['REMOTE_ADDR'], $thread_id));
                    }
                 } catch(PDOException $e){
                        echo 'エラーが発生しました' . $e->getMessage();
                 }
             }

//確認後エントリー
             if(!empty($_POST['entry'])){
                  try{
                      $db = new PDO('mysql:dbname=ranking;host=localhost;charset=utf8','kmmk','uwfyzcyr');

                      $check = $db->prepare("SELECT * FROM vote WHERE name = ? AND thread_id = $thread_id");
                      $check->execute(array($_POST['entry']));
                      $kakunin = $check->fetch();

                        if(isset($kakunin['name'], $kakunin['thread_id'])){
                          echo '<script>window.confirm("既にエントリーされています")</script>';
                        }else{
                          $sql = $db->prepare('INSERT INTO vote SET name = ?, count = 0, id = ?, thread_id = ?');
                          $sql->execute(array($_POST['entry'], uniqid(), $thread_id));
                          echo '<script>window.confirm("エントリー完了しました")</script>';
                        }

                  } catch(PDOException $e){
                      echo 'エラーが発生しました' . $e->getMessage();
                  }
                }

//チェックボックスを表示
              try{
                $sql = $db->prepare('SELECT * FROM vote WHERE thread_id=? ORDER BY count DESC');
                $sql->execute(array($_REQUEST['thread_id']));
                
                echo '<form action="" method="post">';
                echo '<div class="chkbx ms-4 text-dark bg-light bg-opacity-10">';
                foreach ($sql as $row) {
                    echo '<input class="form-check-input" type="checkbox" name="vote[]" value="'.$row['id'].'" onclick="click_cb();">'.$row['name'].' '.$row['count'].'票';
                    echo '<br>';
                }
                echo '</div>';
                echo '<div class="float-end">';
                echo '<button type="submit" class="btn btn-primary">投票</button>';
                echo '</div>';
                echo '</form>';
                } catch(PDOException $e){
                echo 'エラーが発生しました' . $e->getMessage();
            }


          ?>
<!-- JSでチェックボックスの選択数を制限 -->
          <script>
              function click_cb(){
            var check_count = 0;
            $(".chkbx input[type='checkbox']").each(function(){
              if($(this).prop('checked')){
                check_count = check_count+1;
              }
            });
            if(check_count > 2){
              $(".chkbx input[type='checkbox']").each(function(){
                if(!$(this).prop('checked')){
                  $(this).prop('disabled',true);
                }
              });
            }else{
              $(".chkbx input[type='checkbox']").each(function(){
                if(!$(this).prop('checked')){
                  $(this).prop('disabled',false);
                }
              });
            }
            return false;
          }
          </script>
        <br>
      </div>
<!-- その他のエントリーをインサート -->
      <div class="col-md-6">
        <br>
        <form method="POST" action="">
          <div class="row">
            <div class="col-9">
             <input type="text" class="form-control" name="entry" placeholder="その他">
            </div>
            <div class="col-3">
             <button type="submit" class="btn btn-primary">エントリー</button>
            </div>
          </div>
         </form>


       </div>
   </div>
    <br>
   <div class="row">
     <div class="col">
       <a class="btn btn-secondary ms-4" href="keijiban.html?thread_id=<?php echo $thread_id; ?>">掲示板に戻る</a>
     </div>
   </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" 
    integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" 
    crossorigin="anonymous"></script>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
    integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
    crossorigin="anonymous"></script>

</body>